<aside class="sigma-sidebar">
  <h2>Panel de Control</h2>

  <div class="section">
    <div class="section-title">Cargar Escena TIFF</div>
    <div class="upload-area" (click)="fileInput.click()">
      <div class="upload-icon"><i class="pi pi-upload"></i></div>
      <p>Selecciona archivo TIFF/GeoTIFF</p>
      <p class="upload-hint">{{ selectedFile?.name || 'Ningún archivo seleccionado' }}</p>
    </div>
    <input #fileInput type="file" accept=".tiff,.tif" (change)="onFileSelect($event)" hidden>

    <!-- Estado de validación -->
    <div *ngIf="tiffValidating" class="validation-status loading">
      <span><i class="pi pi-spin pi-spinner"></i> Validando TIFF...</span>
    </div>

    <div *ngIf="tiffValidationResult && !tiffValidating" [ngClass]="tiffValidationResult!.valid ? 'validation-status success' : 'validation-status error'">
      <span *ngIf="tiffValidationResult!.valid"><i class="pi pi-check"></i> TIFF válido</span>
      <span *ngIf="!tiffValidationResult!.valid"><i class="pi pi-times"></i> TIFF inválido</span>
      
      <button 
        type="button"
        class="info-btn"
        (click)="toggleTiffInfo()"
        *ngIf="tiffValidationResult"
      >
        <i class="pi" [ngClass]="showTiffInfo ? 'pi-chevron-up' : 'pi-chevron-down'"></i> Detalles
      </button>
    </div>

    <!-- Detalles del TIFF -->
    <div *ngIf="showTiffInfo && tiffValidationResult" class="tiff-details">
      <table>
        <tr>
          <td><strong>Dimensiones:</strong></td>
          <td>{{ tiffValidationResult!.width }} x {{ tiffValidationResult!.height }} px</td>
        </tr>
        <tr>
          <td><strong>Bandas:</strong></td>
          <td>{{ tiffValidationResult!.bandCount }}</td>
        </tr>
        <tr>
          <td><strong>Tipo de dato:</strong></td>
          <td>{{ tiffValidationResult!.dtype }}</td>
        </tr>
        <tr>
          <td><strong>EPSG:</strong></td>
          <td>{{ tiffValidationResult!.epsgCode || 'No especificado' }}</td>
        </tr>
        <tr>
          <td><strong>Compresión:</strong></td>
          <td>{{ tiffValidationResult!.compression || 'Ninguna' }}</td>
        </tr>
        <tr>
          <td><strong>Tiempo estimado:</strong></td>
          <td>{{ tiffValidationResult!.estimatedProcessingTimeSec?.toFixed(2) || 'N/A' }}s</td>
        </tr>
      </table>

      <!-- Advertencias -->
      <div *ngIf="tiffValidationResult!.warnings.length > 0" class="warnings">
        <h5><i class="pi pi-exclamation-triangle"></i> Advertencias:</h5>
        <ul>
          <li *ngFor="let warning of tiffValidationResult!.warnings">{{ warning }}</li>
        </ul>
      </div>
    </div>

    <!-- Error de validación -->
    <div *ngIf="tiffValidationError" class="validation-error">
      <strong><i class="pi pi-exclamation-circle"></i> Error:</strong> {{ tiffValidationError }}
    </div>
    
    <div class="form-group" *ngIf="selectedFile">
      <label>Fecha de Captura</label>
      <input type="date" [(ngModel)]="captureDate" [disabled]="isLoading">
    </div>
    
    <div class="form-group" *ngIf="selectedFile">
      <label>Código EPSG</label>
      <input type="number" [(ngModel)]="epsg" [disabled]="isLoading" placeholder="32717">
      <small class="hint">UTM Zone 17S para Ecuador (EPSG:32717)</small>
      <small *ngIf="tiffValidationResult?.epsgCode && tiffValidationResult?.epsgCode !== epsg" class="hint warning">
        Nota: El archivo contiene EPSG:{{ tiffValidationResult?.epsgCode }}
      </small>
    </div>
    
    <div class="form-group" *ngIf="selectedFile">
      <label>Sensor</label>
      <input type="text" [(ngModel)]="sensor" [disabled]="isLoading" placeholder="drone_dji_phantom">
    </div>
    
    <div class="form-group" *ngIf="selectedFile">
      <label>Región ID</label>
      <select [(ngModel)]="regionId" [disabled]="isLoading || regionsLoading">
        <option value="" disabled>{{ regionsLoading ? 'Cargando regiones...' : 'Selecciona una región' }}</option>
        <option *ngFor="let region of regions" [value]="region.id">{{ region.name }}</option>
      </select>
      <small *ngIf="regionsError" class="hint error">{{ regionsError }}</small>
    </div>
    
    <button class="btn-upload" 
            (click)="onUploadScene()" 
            [disabled]="!canUpload">
      <i class="pi pi-cloud-upload"></i>
      {{ isLoading ? 'Cargando...' : 'Cargar y Segmentar' }}
    </button>
    
    <small class="info-text" *ngIf="!canRunSegmentation && selectedFile">
      <i class="pi pi-info-circle"></i> La segmentación se ejecuta automáticamente al cargar la escena
    </small>
  </div>

  <div class="section">
    <div class="section-title">Aplicar Filtros</div>
  </div>

  <div class="section">
    <div class="filter-title">Filtro Temporal - Período:</div>
    <div class="filter-controls">
      <button 
        class="filter-btn"
        (click)="selectAllMonths()"
        [disabled]="areAllMonthsSelected()"
        title="Seleccionar todos los períodos"
      >
        <i class="pi pi-check-square"></i> Seleccionar todo
      </button>
      <button 
        class="filter-btn"
        (click)="deselectAllMonths()"
        [disabled]="!areAnyMonthsSelected()"
        title="Deseleccionar todos los períodos"
      >
        <i class="pi pi-times"></i> Deseleccionar todo
      </button>
    </div>
    <div class="filter-group">
      <div class="checkbox-item" *ngFor="let month of months" (click)="toggleMonth(month)">
        <input type="checkbox" 
               [id]="'month-' + month.id" 
               [checked]="month.selected"
               [disabled]="isMonthDisabled(month)"
               readonly>
        <label [for]="'month-' + month.id">{{ month.label }}</label>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="filter-title">{{ coverageViewMode === 'categories' ? 'Categorías Segmentadas:' : 'Clases Segmentadas:' }}</div>
    <div class="filter-controls">
      <!-- Vista de Clases -->
      <ng-container *ngIf="coverageViewMode === 'classes'">
        <button 
          class="filter-btn"
          (click)="selectAllClasses()"
          [disabled]="areAllClassesSelected()"
          title="Seleccionar todas las clases"
        >
          <i class="pi pi-check-square"></i> Seleccionar todo
        </button>
        <button 
          class="filter-btn"
          (click)="deselectAllClasses()"
          [disabled]="!areAnyClassesSelected()"
          title="Deseleccionar todas las clases"
        >
          <i class="pi pi-times"></i> Deseleccionar todo
        </button>
      </ng-container>

      <!-- Vista de Categorías -->
      <ng-container *ngIf="coverageViewMode === 'categories'">
        <button 
          class="filter-btn"
          (click)="selectAllCategories()"
          [disabled]="areAllCategoriesSelected()"
          title="Seleccionar todas las categorías"
        >
          <i class="pi pi-check-square"></i> Seleccionar todo
        </button>
        <button 
          class="filter-btn"
          (click)="deselectAllCategories()"
          [disabled]="!areAnyCategoriesSelected()"
          title="Deseleccionar todas las categorías"
        >
          <i class="pi pi-times"></i> Deseleccionar todo
        </button>
      </ng-container>
    </div>

    <!-- Vista de Clases -->
    <div class="filter-group" *ngIf="coverageViewMode === 'classes'">
      <div class="checkbox-item" *ngFor="let classType of sortedClassTypes">
        <input type="checkbox" [id]="'class-' + classType.id" [(ngModel)]="classType.selected" (change)="notifyClassChange()">
        <label [for]="'class-' + classType.id">{{ classType.label }}</label>
      </div>
    </div>

    <!-- Vista de Categorías -->
    <div class="filter-group" *ngIf="coverageViewMode === 'categories'">
      <div class="checkbox-item" *ngFor="let category of selectableCategories">
        <input type="checkbox" [id]="'category-' + category.id" [(ngModel)]="category.selected" (change)="onCategoryChange()">
        <label [for]="'category-' + category.id">{{ category.name }}</label>
      </div>
    </div>
  </div>
</aside>
