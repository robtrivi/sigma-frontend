<div class="dashboard-section">
  <div class="dashboard-card">
    <div class="dashboard-card-header">
      <div class="dashboard-card-title"><i class="pi pi-chart-bar"></i> {{ dashboardTitle }}</div>
      <div class="header-buttons">
        <button class="vis-toggle-btn" (click)="toggleVisualizationType()" [title]="'Visualización: ' + getVisualizationTypeLabel() + ' • Haz clic para cambiar'" *ngIf="sceneId">
          <i class="pi" [ngClass]="visualizationType() === 'mask' ? 'pi-image' : 'pi-camera'"></i>
          {{ getVisualizationTypeLabel() }}
        </button>
        <button class="unit-toggle-btn" (click)="toggleAreaUnit()" [title]="'Unidades: ' + getAreaUnitLabel() + ' • Haz clic para cambiar a ' + (areaUnit() === 'm2' ? 'hectáreas' : 'metros cuadrados')">
          {{ getAreaUnitLabel() }}
          <i class="pi pi-chevron-down"></i>
        </button>
      </div>
    </div>
    
    <!-- Mostrar área total cuando hay cobertura por píxeles -->
    <div class="card-stat" *ngIf="usePixelCoverage">
      <span class="stat-label">Área total ({{ getAreaUnitLabel() }}):</span>
      <span class="stat-value large">{{ convertArea(coverageViewMode() === 'categories' ? totalAreaM2Complete : filteredTotalAreaM2) | noThousandSeparator:'1.2-2' }}</span>
    </div>
    
    <!-- Mostrar conteo de celdas cuando NO hay cobertura por píxeles -->
    <div class="card-stat" *ngIf="!usePixelCoverage">
      <span class="stat-label">{{ statLabel }}:</span>
      <span class="stat-value large">{{ visibleSegmentsCount | noThousandSeparator }}</span>
    </div>
    
    <!-- Mostrar información de clases cuando hay cobertura por píxeles -->
    <div class="card-stat" *ngIf="usePixelCoverage">
      <span class="stat-label">{{ coverageLabel }}:</span>
      <span class="stat-value">{{ convertArea(coverageViewMode() === 'categories' ? coverageAreaM2ForCategories : coverageAreaM2) | noThousandSeparator:'1.2-2' }} {{ getAreaUnitLabel() }} ({{ (coverageViewMode() === 'categories' ? coveragePercentageForCategories : coveragePercentage) | noThousandSeparator:'1.2-2' }}%)</span>
    </div>

    <div class="card-stat" *ngIf="usePixelCoverage && selectedPeriodo">
      <span class="stat-label">Período:</span>
      <span class="stat-value">{{ selectedPeriodo }}</span>
    </div>

    <div class="card-stat">
      <span class="stat-label">{{ coverageViewMode() === 'categories' ? 'Total de Categorías:' : 'Total de Clases:' }}</span>
      <span class="stat-value">{{ coverageViewMode() === 'categories' ? selectedCategoriesCount : selectedClassesCount }}</span>
    </div>
    
    <!-- Mostrar información de celdas cuando NO hay cobertura por píxeles -->
    <div class="card-stat" *ngIf="!usePixelCoverage">
      <span class="stat-label">Total de celdas:</span>
      <span class="stat-value">{{ totalSegmentsCount | noThousandSeparator }}</span>
    </div>

    <div class="card-stat" *ngIf="!usePixelCoverage">
      <span class="stat-label">{{ coverageLabel }}:</span>
      <span class="stat-value">{{ convertArea(coverageAreaM2) | noThousandSeparator:'1.2-2' }} {{ getAreaUnitLabel() }} ({{ coveragePercentage | noThousandSeparator:'1.2-2' }}%)</span>
    </div>
  </div>

  <!-- ===== NUEVA SECCIÓN: COBERTURA POR PÍXELES ===== -->
  <div class="dashboard-card" *ngIf="sceneId || (usePixelCoverage && filteredPixelCoverageData.length > 0)">
    <div class="dashboard-card-title">
      <i class="pi pi-objects-column"></i> Cobertura de Área ({{ getAreaUnitLabel() }})
    </div>

    <div *ngIf="isLoadingCoverage" class="loading-state">
      <i class="pi pi-spin pi-spinner"></i> Cargando análisis de área...
    </div>

    <div *ngIf="coverageError" class="error-state">
      <i class="pi pi-exclamation-circle"></i> {{ coverageError }}
    </div>

    <div *ngIf="!isLoadingCoverage && !coverageError && pixelCoverageData.length > 0">
      <div class="coverage-header">
        <span class="header-label">Área total ({{ getAreaUnitLabel() }}):</span>
        <span class="header-value">{{ convertArea(filteredTotalAreaM2) | noThousandSeparator:'1.2-2' }}</span>
      </div>

      <!-- Botones para cambiar vista (Clases vs Categorías) -->
      <div class="coverage-view-toggle">
        <button 
          class="toggle-btn"
          [class.active]="coverageViewMode() === 'classes'"
          (click)="changeCoverageViewMode('classes')"
        >
          <i class="pi pi-list"></i> Por Clases
        </button>
        <button 
          class="toggle-btn"
          [class.active]="coverageViewMode() === 'categories'"
          (click)="changeCoverageViewMode('categories')"
        >
          <i class="pi pi-objects-column"></i> Por Categorías
        </button>
      </div>

      <!-- Tabla de Clases Individuales -->
      <table class="coverage-table" *ngIf="coverageViewMode() === 'classes'">
        <thead>
          <tr>
            <th>Color</th>
            <th>Clase</th>
            <th>Área ({{ getAreaUnitLabel() }})</th>
            <th>Cobertura (%)</th>
            <th>Visualización</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of filteredPixelCoverageData">
            <td class="color-cell">
              <div 
                class="color-box" 
                [style.background-color]="getClassColor(item.class_name)"
                (click)="openColorPicker(item.class_name)"
                title="Haz clic para cambiar el color"
              ></div>
            </td>
            <td>{{ item.class_name }}</td>
            <td class="area-m2">{{ convertArea(item.area_m2 || 0) | noThousandSeparator:'1.2-2' }}</td>
            <td class="coverage-percentage">{{ ((item.area_m2 || 0) / (filteredTotalAreaM2 || 1) * 100).toFixed(2) }}%</td>
            <td class="coverage-bar">
              <div class="progress-bar-pixel">
                <div
                  class="progress-fill-pixel"
                  [style.width.%]="(item.area_m2 || 0) / (filteredTotalAreaM2 || 1) * 100"
                  [style.background-color]="getClassColor(item.class_name)"
                ></div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Tabla de Categorías -->
      <table class="coverage-table" *ngIf="coverageViewMode() === 'categories'">
        <thead>
          <tr>
            <th>Color</th>
            <th>Categoría</th>
            <th>Área ({{ getAreaUnitLabel() }})</th>
            <th>Cobertura (%)</th>
            <th>Visualización</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let category of categorizedCoverageData" class="category-row">
            <td class="color-cell">
              <div 
                class="color-box" 
                [style.background-color]="category.categoryColor"
                (click)="openCategoryColorPicker(category.categoryName)"
                title="Haz clic para cambiar el color"
              ></div>
            </td>
            <td class="category-name">{{ category.categoryName }}</td>
            <td class="area-m2">{{ convertAreaForCategory(category.totalAreaM2) | noThousandSeparator:'1.2-2' }}</td>
            <td class="coverage-percentage">{{ category.percentageOfTotal.toFixed(2) }}%</td>
            <td class="coverage-bar">
              <div class="progress-bar-pixel">
                <div
                  class="progress-fill-pixel"
                  [style.width.%]="category.percentageOfTotal"
                  [style.background-color]="category.categoryColor"
                ></div>
              </div>
            </td>
          </tr>
          <!-- Detalles de clases dentro de cada categoría -->
          <tr *ngFor="let category of categorizedCoverageData; let catIndex = index; let last = last" class="category-details">
            <td colspan="5" *ngIf="category.classesInCategory.length > 0">
              <div class="category-classes">
                <!-- Encabezado de categoría -->
                <div class="category-header">
                  <i class="pi pi-angle-right"></i>
                  <span class="category-title">{{ category.categoryName }}</span>
                </div>
                <!-- Clases dentro de la categoría -->
                <div *ngFor="let classItem of category.classesInCategory" class="class-detail-row">
                  <span class="indent"></span>
                  <span class="detail-label">{{ classItem.className }}:</span>
                  <span class="detail-value">{{ convertAreaForCategory(classItem.areaM2) | noThousandSeparator:'1.2-2' }} ({{ classItem.percentageOfCategory.toFixed(1) }}% de la categoría)</span>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
<!-- Color Picker Modal -->
<app-class-color-picker
  *ngIf="showColorPicker"
  [className]="selectedColorClass || selectedColorCategory"
  [currentColor]="selectedColorClass ? selectedColorValue : selectedCategoryColorValue"
  [originalClassColors]="selectedColorClass ? originalClassColors : getMappedCategoryColors()"
  (colorSelected)="onColorSelected($event)"
  (close)="onColorPickerClose()"
></app-class-color-picker>