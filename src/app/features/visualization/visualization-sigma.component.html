<div class="sigma-page">
  <app-visualization-header class="sigma-header"></app-visualization-header>

  <div class="sigma-container">
    <div class="sigma-main-layout">
      <app-control-panel
        [uploadedFile]="uploadedFile"
        [hoveredFeature]="hoveredFeature"
        [months]="months"
        [classTypes]="classTypes"
        [isLoading]="isLoading()"
        [canRunSegmentation]="canRunSegmentation"
        (sceneUpload)="onSceneUpload($event)"
        (runSegmentation)="onRunSegmentation()"
        (monthFilterChange)="onMonthFilterChange()"
        (classFilterChange)="onClassFilterChange()"
      ></app-control-panel>

      <main class="sigma-main-content">
      <div class="status-bar">
        <span>{{ getStatusMessage() }}</span>
      </div>

      <div class="tab-container" *ngIf="getSelectedMonths().length > 1">
        <div class="tab" 
             *ngFor="let month of getSelectedMonths()" 
             [class.active]="activeMonth === month.id"
             (click)="setActiveMonth(month.id)">
          <i class="pi pi-calendar"></i> {{ month.label }}
        </div>
      </div>

      <div class="content-wrapper">
        <app-leaflet-map
          [center]="[-2.1448, -79.9651]"
          [zoom]="15"
          [showLegend]="true"
          [sceneId]="currentScene?.sceneId"
          [regionId]="selectedRegionId"
          [periodo]="selectedPeriodo"
          [selectedClassIds]="getSelectedClassIds()"
          (featureClick)="onFeatureClick($event)"
          (multipeMasksLoaded)="onMultipleMasksLoaded($event)"
        ></app-leaflet-map>

        <app-dashboard-panel
          [dashboardTitle]="getDashboardTitle()"
          [statLabel]="getStatLabel()"
          [visibleCellsCount]="getVisibleSegmentsCount()"
          [totalCells]="usePixelCoverage ? filteredTotalPixels : segmentFeatures().length"
          [coverageLabel]="getCoverageLabel()"
          [coveragePercentage]="getCoveragePercentage()"
          [coverageAreaM2]="getCoverageAreaM2()"
          [selectedPeriodo]="getSelectedPeriodoLabel()"
          [sceneId]="currentScene?.sceneId"
          [usePixelCoverage]="usePixelCoverage"
          [imageResolution]="usePixelCoverage ? '512Ã—512' : ''"
          [selectedClassIds]="getSelectedClassIds()"
          [selectedClassesCount]="getSelectedClassesCountForDashboard()"
          [pixelCoverageDataInput]="filteredPixelCoverageData"
          [totalPixelsInput]="filteredTotalPixels"
        ></app-dashboard-panel>
      </div>

      <div class="bottom-toolbar">
        <div class="toolbar-info">
          {{ getToolbarInfo() }}
        </div>
        <div class="toolbar-buttons">
          <button class="btn-secondary" [routerLink]="['/']">Volver al Inicio</button>
          <button class="btn-secondary" (click)="clearFilters()">Limpiar Filtros</button>
          <button class="btn-primary" (click)="downloadReport()">Descargar Informe</button>
        </div>
      </div>
      </main>
    </div>
  </div>

  <app-download-modal 
    *ngIf="showDownloadModal"
    (close)="onDownloadModalClose()"
    (download)="onDownloadModalSubmit($event)"
  ></app-download-modal>

  <app-segmentation-progress-dialog
    [isVisible]="showProgressDialog"
    [sceneId]="progressSceneId"
    (onClose)="onProgressDialogClose()"
    (onVisualize)="onVisualizeMapa($event)"
  ></app-segmentation-progress-dialog>
</div>
