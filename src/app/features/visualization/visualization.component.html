<p-toast />

<app-page-header
  title="Visualización de Mapa Segmentado"
  subtitle="Explora el mapa segmentado con clasificación de áreas"
  [breadcrumbs]="[{ label: 'Inicio', routerLink: '/' }, { label: 'Visualización' }]"
/>

@if (loading()) {
  <div class="loading-container card-shadow">
    <i class="pi pi-spin pi-spinner" style="font-size: 3rem"></i>
    <p>Cargando mapa...</p>
  </div>
} @else {
  <div class="visualization-layout">
    <!-- Map Section -->
    <div class="map-section card-shadow">
      <div class="map-header">
        <h3>
          <i class="pi pi-map"></i>
          Mapa Segmentado
        </h3>
        @if (selectedCells().length > 0) {
          <button 
            pButton 
            label="Limpiar Selección" 
            icon="pi pi-times"
            class="p-button-sm p-button-warning"
            (click)="clearSelection()">
          </button>
        }
      </div>

      <div class="map-container">
        <div class="map-grid">
          @for (cell of mapCells(); track cell.id) {
            <div 
              class="map-cell"
              [class.selected]="cell.selected"
              [style.background-color]="getCellColor(cell.type)"
              (mouseenter)="onCellHover(cell)"
              (mouseleave)="onCellLeave()"
              (click)="onCellClick(cell)"
            >
              @if (cell.selected) {
                <div class="selection-indicator">
                  <i class="pi pi-check"></i>
                </div>
              }
            </div>
          }
        </div>

        <!-- Legend -->
        <div class="map-legend">
          <h4>Leyenda</h4>
          @for (item of legend(); track item.type) {
            <div class="legend-item">
              <div class="legend-color" [style.background-color]="item.color"></div>
              <span>{{ item.label }}</span>
              <span class="legend-count">({{ item.count }})</span>
            </div>
          }
        </div>

        <!-- Selection hint -->
        @if (selectedCells().length > 0) {
          <div class="selection-hint">
            <i class="pi pi-info-circle"></i>
            {{ selectedCells().length }} celda(s) seleccionada(s)
          </div>
        }
      </div>
    </div>

    <!-- Info Panel -->
    <div class="info-panel">
      <!-- Hovered Cell Info -->
      @if (hoveredCell(); as cell) {
        <div class="info-card card-shadow">
          <h3>
            <i class="pi pi-map-marker"></i>
            Información de Zona
          </h3>
          <div class="info-content">
            <div class="info-row">
              <span class="info-label">Nombre:</span>
              <span class="info-value">{{ cell.name }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Tipo:</span>
              <span class="info-value">{{ getTypeLabel(cell.type) }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Área:</span>
              <span class="info-value">{{ cell.area.toLocaleString() }} m²</span>
            </div>
            <div class="info-row">
              <span class="info-label">Posición:</span>
              <span class="info-value">Fila {{ cell.row + 1 }}, Col {{ cell.col + 1 }}</span>
            </div>
          </div>
        </div>
      } @else {
        <div class="info-card card-shadow">
          <h3>
            <i class="pi pi-info-circle"></i>
            Información
          </h3>
          <div class="info-placeholder">
            <i class="pi pi-map" style="font-size: 2rem; opacity: 0.3"></i>
            <p>Pasa el mouse sobre una celda para ver detalles</p>
          </div>
        </div>
      }

      <!-- SubRegion Analysis -->
      @if (subRegion(); as region) {
        <div class="analysis-card card-shadow">
          <h3>
            <i class="pi pi-chart-bar"></i>
            Análisis de Subregión
          </h3>
          <div class="analysis-content">
            <h4>{{ region.name }}</h4>
            <div class="metrics-mini">
              <div class="metric-mini">
                <span class="metric-label">Celdas:</span>
                <span class="metric-value">{{ region.cells.length }}</span>
              </div>
              <div class="metric-mini">
                <span class="metric-label">Área Total:</span>
                <span class="metric-value">{{ region.totalArea.toLocaleString() }} m²</span>
              </div>
              <div class="metric-mini">
                <span class="metric-label">Cobertura Verde:</span>
                <span class="metric-value success">{{ region.greenCoverage }}%</span>
              </div>
            </div>
          </div>
        </div>
      }

      <!-- Instructions -->
      <div class="instructions-card card-shadow">
        <h3>
          <i class="pi pi-question-circle"></i>
          Instrucciones
        </h3>
        <ul>
          <li><strong>Hover:</strong> Pasa el mouse sobre una celda para ver información</li>
          <li><strong>Click:</strong> Haz clic en celdas para seleccionarlas</li>
          <li><strong>Análisis:</strong> Selecciona múltiples celdas para análisis de subregión</li>
          <li><strong>Limpiar:</strong> Usa el botón para deseleccionar todas las celdas</li>
        </ul>
      </div>
    </div>
  </div>
}
